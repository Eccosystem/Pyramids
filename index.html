<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Echoes - An Interactive Journey</title>
    <meta name="description" content="Explore the ancient mysteries of the Bosnian Pyramids through an interactive art project. Discover stories, meditate on the energies, and share your own experiences.">
    <meta name="keywords" content="Bosnian Pyramids, interactive art, ancient wisdom, mystical, prophecy, meditation, spiritual, energy, runes, AI">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✨</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Spectral:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This is a global object to store Firebase instances and data
        window.firebase = {
            app: null,
            auth: null,
            db: null,
            userId: null,
        };

        window.firebaseInit = async function() {
            try {
                // The Canvas environment provides the Firebase config and auth token automatically
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. The app will not be able to save stories.");
                    return;
                }

                window.firebase.app = initializeApp(firebaseConfig);
                window.firebase.db = getFirestore(window.firebase.app);
                window.firebase.auth = getAuth(window.firebase.app);

                // Sign in the user using the provided custom token or anonymously
                onAuthStateChanged(window.firebase.auth, (user) => {
                    if (user) {
                        window.firebase.userId = user.uid;
                        console.log("Firebase authenticated. User ID:", window.firebase.userId);
                    } else {
                        console.error("Firebase authentication failed. App cannot access Firestore.");
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(window.firebase.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.firebase.auth);
                }

            } catch (e) {
                console.error("Error initializing Firebase:", e);
            }
        };
    </script>
    <style>
        :root {
            --night-bg-start: #10141c;
            --night-bg-end: #000000;
            --day-bg-start: #87CEEB;
            --day-bg-end: #f0f8ff;
            --primary-night: #FFD700;
            --primary-day: #1e3a8a;
            --secondary-night: #e0e0e0;
            --secondary-day: #4a5568;
        }
        @media (prefers-reduced-motion: reduce) {
            body, .main-content-area, .pyramid, .celestial-body, .beam {
                animation: none !important;
                transition: none !important;
            }
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            display: flex; flex-direction: column; justify-content: flex-start;
            align-items: center; margin: 0; overflow-x: hidden; position: relative;
            background: radial-gradient(circle at center, var(--night-bg-start) 0%, var(--night-bg-end) 100%);
            animation: background-pulse 20s ease-in-out infinite alternate;
            transition: background 2s ease-in-out;
        }
        body[data-theme="day"] {
            background: linear-gradient(to bottom, var(--day-bg-start) 0%, #c1e1f2 70%, var(--day-bg-end) 100%);
            animation: none;
        }
        body[data-theme="night"] {
            background: radial-gradient(circle at center, var(--night-bg-start) 0%, var(--night-bg-end) 100%);
        }
        @keyframes background-pulse {
            0% { background-color: var(--night-bg-start); }
            100% { background-color: #151a25; }
        }
        body::before, body::after {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            transition: opacity 2s ease-in-out; background-attachment: fixed; z-index: -1;
        }
        body[data-theme="night"]::before {
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
            background-size: 4px 4px; opacity: 0.4; animation: drift 80s linear infinite;
        }
        body[data-theme="day"]::before { opacity: 0; }
        body[data-theme="day"]::after {
            background-image: url('https://www.transparenttextures.com/patterns/clouds.png'), url('https://www.transparenttextures.com/patterns/soft-wallpaper.png');
            background-repeat: repeat; opacity: 0.1; animation: drift-slow 180s linear infinite;
        }
        body[data-theme="night"]::after { opacity: 0; }
        @keyframes drift {
            from { background-position: 0 0; }
            to { background-position: 200% 200%; }
        }
        @keyframes drift-slow {
            from { background-position: 0 0; }
            to { background-position: 400px 0; }
        }
        .main-content-area {
            width: 95%; max-width: 900px; display: flex; flex-direction: column;
            align-items: center; padding: 1rem; box-sizing: border-box; z-index: 10;
            opacity: 0; transition: opacity 1.5s ease-in-out;
        }
        .main-content-area.active { opacity: 1; }
        .app-header {
            width: 100%; display: flex; justify-content: space-between;
            align-items: center; padding: 1rem 0; z-index: 20;
        }
        .title-container { text-align: left; flex-grow: 1; }
        .app-header h1 {
            font-family: 'Spectral', serif; font-size: clamp(1.5rem, 4vw, 2.2rem);
            margin: 0; text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            animation: title-glow 4s infinite alternate; color: var(--primary-night);
            letter-spacing: 0.1em;
        }
        .runic-subtitle {
            font-family: 'Spectral', serif; font-size: clamp(0.8rem, 2vw, 1rem);
            color: #b8860b; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            margin: 0.25rem 0 0 0; letter-spacing: normal;
        }
        body[data-theme="day"] .app-header h1 {
            color: var(--primary-day); animation: none; text-shadow: 0 1px 3px rgba(255, 255, 255, 0.7);
        }
        body[data-theme="day"] .runic-subtitle {
            color: var(--secondary-day); text-shadow: none;
        }
        @keyframes title-glow {
            from { text-shadow: 0 0 15px rgba(255, 215, 0, 0.6); color: var(--primary-night); }
            to { text-shadow: 0 0 20px rgba(255, 180, 0, 0.9); color: #fff8e1; }
        }
        .menu-button { display: none; }
        .overlay-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 0, 20, 0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .overlay-menu.active { opacity: 1; visibility: visible; }
        .overlay-menu-close {
            position: absolute; top: 1rem; right: 1rem; background: none; border: none;
            color: var(--primary-night); font-size: 2rem; cursor: pointer; transition: transform 0.3s ease;
        }
        .overlay-menu-close:hover { transform: rotate(90deg); }
        .overlay-menu nav ul {
            list-style: none; padding: 0; display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            width: 100%; max-width: 600px;
        }
        .overlay-menu nav ul li a {
            color: var(--secondary-night); font-size: clamp(1.2rem, 3vw, 1.5rem); text-decoration: none;
            display: flex; flex-direction: row; align-items: center;
            gap: 1rem; transition: all 0.3s ease;
            font-family: 'Spectral', serif;
            text-shadow: none;
        }
        .overlay-menu nav ul li a:hover {
            color: var(--primary-night);
            transform: translateX(10px);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        .runic-icon {
            font-size: 2rem;
            color: var(--primary-night);
            transition: all 0.3s ease;
        }
        .overlay-menu nav ul li a:hover .runic-icon {
            transform: scale(1.2);
            filter: drop-shadow(0 0 8px var(--primary-night));
        }
        .overlay-menu-close svg {
            color: var(--primary-night);
            transition: transform 0.3s ease, filter 0.3s ease;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
        }
        .overlay-menu-close:hover svg {
            transform: rotate(90deg);
            filter: drop-shadow(0 0 10px var(--primary-night));
        }
        .pyramids-visual-group {
            position: relative; width: 100%; display: flex; justify-content: center; align-items: flex-end;
            margin-top: 2rem; min-height: 350px;
        }
        .pyramid-container {
            display: flex; justify-content: center; align-items: flex-end; gap: 1.5rem;
        }
        .pyramid {
            position: relative; cursor: pointer; transition: transform 0.3s ease;
            display: flex; flex-direction: column; align-items: center;
        }
        .pyramid:hover { transform: translateY(-5px); }
        .pyramid-shape {
            background: linear-gradient(45deg, #4a4a4a, #1a1a1a);
            width: 100%; aspect-ratio: 2 / 1; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            position: relative;
        }
        .pyramid-shape::before {
            content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 50%);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%); opacity: 0.7;
        }
        .pyramid-shape::after {
            content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 30%);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }
        .pyramid-name {
            margin-top: 0.75rem; font-family: 'Spectral', serif;
        }
        body[data-theme="night"] .pyramid-name {
            color: var(--primary-night); text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }
        body[data-theme="day"] .pyramid-name {
            color: var(--primary-day); text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        .pyramid.center { width: 250px; }
        .pyramid.center .pyramid-shape { background: linear-gradient(45deg, #DAA520, #B8860B); }
        .pyramid.side { width: 90px; transform: translateY(30px); }
        .pyramid.side:hover { transform: translateY(25px); }
        .beam {
            position: absolute; bottom: 95%; left: 50%; width: 15px; height: 100vh;
            transform-origin: bottom center; background: linear-gradient(to top, var(--beam-color-start), var(--beam-color-end));
            opacity: 0; filter: blur(8px); animation: beam-flicker 4s ease-in-out infinite;
        }
        .beam.red { --beam-color-start: rgba(255, 60, 60, 0.8); --beam-color-end: rgba(255, 120, 120, 0); animation-delay: 1s; }
        .beam.green { --beam-color-start: rgba(80, 255, 80, 0.8); --beam-color-end: rgba(120, 255, 120, 0); animation-delay: 0s; }
        .beam.gold { --beam-color-start: rgba(255, 215, 0, 0.8); --beam-color-end: rgba(255, 225, 50, 0); animation-delay: 0.5s; }
        @keyframes beam-flicker {
            0%, 100% { transform: translateX(-50%) scaleY(0.95); opacity: 0.7; }
            10% { transform: translateX(-50%) scaleY(1); opacity: 0.9; }
            20% { transform: translateX(-50%) scaleY(0.98); opacity: 0.8; }
            30% { transform: translateX(-50%) scaleY(1.02); opacity: 0.95; }
            40%, 60% { transform: translateX(-50%) scaleY(1); opacity: 0.85; }
            50% { transform: translateX(-50%) scaleY(0.95); opacity: 0.7; }
            70% { transform: translateX(-50%) scaleY(1); opacity: 0.9; }
            80% { transform: translateX(-50%) scaleY(0.97); opacity: 0.75; }
            90% { transform: translateX(-50%) scaleY(1); opacity: 0.9; }
        }
        .echo-counter {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-top: 1rem; padding: 1rem; width: 100%; max-width: 250px;
            background-color: rgba(255, 215, 0, 0.05); border: 1px solid var(--primary-night);
            border-radius: 10px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            text-align: center; transition: all 0.5s ease-in-out;
        }
        body[data-theme="day"] .echo-counter {
            background-color: rgba(30, 58, 138, 0.05); border: 1px solid var(--primary-day);
            box-shadow: 0 0 15px rgba(30, 58, 138, 0.3);
        }
        .echo-counter-label {
            font-family: 'Spectral', serif; color: var(--primary-night); font-size: clamp(0.9rem, 1.5vw, 1.1rem);
            text-transform: uppercase; letter-spacing: 0.1em; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            transition: color 0.5s, text-shadow 0.5s;
        }
        body[data-theme="day"] .echo-counter-label { color: var(--primary-day); text-shadow: 0 1px 3px rgba(255, 255, 255, 0.7); }
        .echo-counter-value {
            font-family: 'Spectral', serif; font-size: clamp(2rem, 5vw, 3rem); color: var(--primary-night);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7); margin-top: 0.5rem;
            animation: text-glow 3s infinite alternate; transition: color 0.5s, text-shadow 0.5s;
        }
        body[data-theme="day"] .echo-counter-value {
            color: var(--primary-day); text-shadow: 0 1px 3px rgba(255, 255, 255, 0.7); animation: none;
        }
        @keyframes text-glow {
            from { text-shadow: 0 0 10px rgba(255, 215, 0, 0.7); }
            to { text-shadow: 0 0 20px rgba(255, 215, 0, 0.9); }
        }
        .whisper-box {
            background-color: rgba(0, 0, 0, 0.5); border: 1px solid #4A5568;
            border-radius: 0.75rem; padding: 1.2rem; margin-top: 1.5rem;
            min-height: 80px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            font-style: italic; font-size: clamp(0.9rem, 1.5vw, 1.1rem); max-width: 90%;
            width: 100%; position: relative;
        }
        .whisper-box.loading::after { content: '...'; animation: blinking-dots 1.5s infinite; position: absolute; }
        @keyframes blinking-dots { 0%{opacity: 0;} 50%{opacity: 1;} 100%{opacity: 0;} }
        .runic-text {
            font-family: 'Spectral', serif; font-size: clamp(1.5rem, 3vw, 2.2rem);
            color: var(--primary-night); text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); min-height: 1.5em;
        }
        .english-translation {
            color: var(--secondary-night); opacity: 0; max-height: 0; overflow: hidden;
            transition: opacity 0.5s ease, max-height 0.5s ease;
        }
        .english-translation.visible { opacity: 1; max-height: 500px; margin-top: 0.5rem; }
        .runic-toggle {
            background: none; border: 1px solid var(--primary-night); color: var(--primary-night); cursor: pointer;
            padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: all 0.3s;
            margin-top: 1rem; display: none;
        }
        .runic-toggle:hover { background-color: rgba(255,215,0,0.1); }
        .post-reading-message {
            margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #4a5568;
            text-align: center; color: #a0aec0; font-style: italic; display: none;
        }
        .post-reading-message .donate-button-small {
            margin-top: 1rem; display: inline-block; background: #5a6578; color: #ffcc00;
            padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: bold; transition: all 0.3s ease;
        }
        .post-reading-message .donate-button-small:hover { background: #6a7588; transform: translateY(-2px); }
        .user-input-section {
            display: flex; flex-direction: column; align-items: center; width: 90%; max-width: 500px;
            margin-top: 1.5rem; gap: 0.75rem;
        }
        .whisper-button {
            background: linear-gradient(to bottom right, #5a6578, #3d4758); color: #ffcc00;
            padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease; border: none; width: 100%;
        }
        .whisper-button:hover { background: linear-gradient(to bottom right, #6a7588, #4d5768); transform: translateY(-2px); }
        .whisper-button:disabled { background: #3d4758; color: #a0aec0; cursor: not-allowed; }
        .page { display: none; width: 100%; }
        .page.active { display: flex; flex-direction: column; align-items: center; animation: fadeIn 1s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-content-container {
            width: 100%; max-width: 900px; background-color: rgba(0,0,0,0.6);
            border: 1px solid #4a5568; border-radius: 1rem; padding: 2rem; margin-top: 1.5rem;
        }
        body[data-theme="day"] .page-content-container {
            background-color: rgba(255, 255, 255, 0.6); border: 1px solid rgba(0,0,0,0.1);
        }
        #messageFeedback { color: var(--primary-night); font-style: italic; margin-top: 1rem; min-height: 4em; }
        #runeDisplay {
            font-family: 'Spectral', serif; font-size: 3rem; letter-spacing: 0.5rem;
            color: var(--primary-night); text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            margin-top: 1.5rem; min-height: 1.5em;
        }
        #runeInterpretation { color: var(--secondary-night); font-style: italic; margin-top: 1rem; min-height: 3em; line-height: 1.6; }
        .storyteller-runes {
            font-family: 'Spectral', serif; font-size: clamp(2rem, 5vw, 3rem); color: var(--primary-night);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }
        .storyteller-meaning {
            font-family: 'Spectral', serif; font-style: italic; color: #a0aec0;
            font-size: clamp(1rem, 2vw, 1.2rem); margin-top: 0.5rem;
        }
        .storyteller-stories { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #4a5568; }
        .storyteller-stories h3 {
            font-family: 'Spectral', serif; font-size: 1.5rem; color: var(--primary-night);
            text-align: center; margin-bottom: 1rem;
        }
        .story-card {
            background-color: rgba(0,0,0,0.3); border: 1px solid #4a5568;
            border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;
        }
        .story-card .story-rune {
            font-family: 'Spectral', serif; font-size: 2rem; color: var(--primary-night);
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }
        .story-card .story-text { color: #e0e0e0; margin-top: 0.5rem; font-style: italic; }
        .story-card .story-meta {
            color: #a0aec0; font-size: 0.8rem; margin-top: 0.5rem; display: flex;
            justify-content: space-between; align-items: center;
        }
        .story-card .story-meta .story-user-id {
            font-family: monospace; overflow: hidden; text-overflow: ellipsis;
            white-space: nowrap; max-width: 150px;
        }
        .story-card .story-meta .story-timestamp { font-style: normal; }
        #homePage { position: relative; }
        .theme-switcher { display: flex; gap: 0.5rem; margin-block: 1.5rem; }
        .theme-button {
            background: rgba(0,0,0,0.4); color: #fff; padding: 0.5rem 1rem;
            border-radius: 2rem; cursor: pointer; transition: all 0.3s ease;
            font-weight: bold; border: 1px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; gap: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .theme-button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .theme-button.active {
            background: var(--primary-night); color: #333; box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }
        .theme-button svg { width: 1.2em; height: 1.2em; fill: currentColor; }
        #initialEntryOverlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; display: flex; justify-content: center; align-items: center; text-align: center;
            z-index: 2000; color: var(--primary-night); transition: opacity 1.5s ease-out;
            cursor: pointer;
        }
        #initialEntryOverlay.hidden { opacity: 0; pointer-events: none; }
        .entry-title { font-size: clamp(1.5rem, 4vw, 2.5rem); font-family: 'Spectral', serif; order: 2; margin-top: 1.5rem;}
        .entry-instruction {
            font-size: clamp(1rem, 2vw, 1.5rem); color: var(--secondary-night); opacity: 0.8; margin-top: 1rem; order: 3;
            animation: pulse-text 2s infinite alternate;
        }
        @keyframes pulse-text { from { opacity: 0.8; transform: scale(1); } to { opacity: 1; transform: scale(1.05); } }
        .entry-runic {
            font-family: 'Spectral', serif; font-size: clamp(2rem, 6vw, 3.5rem);
            color: var(--primary-night); text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
            letter-spacing: 0.1em; order: 1;
        }
        .moon-orbit {
            position: fixed; top: 5%; left: 5%; width: calc(90% - 80px); height: 80px;
            z-index: 50; animation: move-across 90s linear infinite alternate;
            pointer-events: none;
        }
        @keyframes move-across { from { transform: translateX(0); } to { transform: translateX(100%); } }
        .celestial-body {
            width: 80px; height: 80px; border-radius: 50%;
            transition: all 2s ease-in-out; background-size: cover; background-position: center;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Spectral', serif; font-weight: bold; font-size: 2rem;
            cursor: pointer; user-select: none; pointer-events: auto;
            color: var(--primary-night); text-shadow: 0 0 8px rgba(255, 255, 255, 0.7);
            position: relative;
        }
        .celestial-body-rune { transition: opacity 0.3s ease; }
        .celestial-body-label {
            position: absolute; opacity: 0; font-size: 1rem; font-weight: normal;
            transition: opacity 0.3s ease, transform 0.3s ease; transform: translateY(150%);
            pointer-events: none; text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            background-color: rgba(0, 0, 0, 0.6); padding: 0.25rem 0.75rem;
            border-radius: 9999px; border: 1px solid var(--primary-night);
        }
        .celestial-body:hover .celestial-body-rune { opacity: 0; }
        .celestial-body:hover .celestial-body-label { opacity: 1; transform: translateY(150%); }
        body[data-theme="night"] .celestial-body {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/FullMoon2010.jpg/1200px-FullMoon2010.jpg');
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        body[data-theme="day"] .celestial-body {
            background-color: var(--primary-night); background-image: none;
            box-shadow: 0 0 50px var(--primary-night), 0 0 100px #FFA500;
            animation: sun-glow 4s infinite alternate; color: var(--primary-night);
            text-shadow: 0 0 8px rgba(100, 50, 0, 0.6);
        }
        @keyframes sun-glow { from { box-shadow: 0 0 50px var(--primary-night), 0 0 100px #FFA500; } to { box-shadow: 0 0 70px #FFFF00, 0 0 120px var(--primary-night); } }
        .audio-controls {
            position: fixed; bottom: 1rem; right: 1rem;
            display: flex; flex-direction: column; align-items: flex-end;
            gap: 0.5rem; z-index: 1000;
        }
        .audio-toggle-button {
            background: #5a6578; color: #ffcc00; padding: 0.5rem 1rem;
            border-radius: 0.5rem; font-weight: bold; cursor: pointer;
            z-index: 1000; transition: all 0.3s ease;
        }
        .audio-toggle-button.active { background: linear-gradient(to bottom, #ffcc00, #b8860b); color: #333; }
        .volume-container {
            display: flex; align-items: center; gap: 0.5rem;
            color: #a0aec0; font-size: 0.8rem; background: rgba(0, 0, 0, 0.6);
            padding: 0.25rem 0.75rem; border-radius: 9999px;
            border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease;
        }
        .volume-container input[type=range] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 100px; height: 5px; background: #d3d3d3; outline: none;
            opacity: 0.7; -webkit-transition: .2s; transition: opacity .2s;
        }
        .volume-container input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 15px; height: 15px;
            border-radius: 50%; background: #ffcc00; cursor: pointer;
        }
        .volume-container input[type=range]::-moz-range-thumb {
            width: 15px; height: 15px; border-radius: 50%;
            background: #ffcc00; cursor: pointer;
        }
        .meditation-circle {
            width: clamp(150px, 30vw, 250px); height: clamp(150px, 30vw, 250px);
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4), transparent);
            border-radius: 50%; margin: 2rem auto; display: flex;
            justify-content: center; align-items: center; transition: all 1s ease-in-out;
        }
        .meditation-circle.pulsing { animation: pulse-meditation 4s infinite alternate ease-in-out; }
        @keyframes pulse-meditation {
            from { transform: scale(1); box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
            to { transform: scale(1.05); box-shadow: 0 0 50px rgba(255, 215, 0, 0.8); }
        }
        .meditation-circle .rune-symbol { font-size: clamp(4rem, 8vw, 6rem); color: var(--primary-night); }
        .meditation-button {
            background: #5a6578; color: #ffcc00; padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease;
        }
        .meditation-button.active { background: linear-gradient(to bottom, #ffcc00, #b8860b); color: #333; }
        .meditation-call-to-action {
            margin-top: 1.5rem; text-align: center;
            color: #a0aec0; font-style: italic;
        }
        .rune-alphabet-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 1rem; margin-top: 2rem; padding-top: 1.5rem;
            border-top: 1px solid #4a5568; width: 100%;
        }
        .rune-alphabet-item {
            display: flex; flex-direction: column; align-items: center;
            background-color: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.5rem;
        }
        .rune-alphabet-char { font-family: 'Spectral', serif; font-size: 2rem; color: var(--primary-night); }
        .rune-alphabet-name { font-size: 0.8rem; color: #a0aec0; margin-top: 0.25rem; }
        .rune-history {
            margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid #4a5568;
            width: 100%; text-align: left; line-height: 1.7; color: #a0aec0;
        }
        .rune-history h3 {
            font-family: 'Spectral', serif; font-size: 1.5rem; color: var(--primary-night);
            text-align: center; margin-bottom: 1rem;
        }
        .rune-image-gallery {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem; margin-top: 2rem; padding-top: 1.5rem;
            border-top: 1px solid #4a5568; width: 100%;
        }
        .rune-image-gallery img {
            width: 100%; height: auto; border-radius: 0.5rem;
            border: 1px solid #4a5568; object-fit: cover; aspect-ratio: 4 / 3;
        }
        .about-call-to-action {
            margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid #4a5568;
        }
        .about-call-to-action h3 {
            font-family: 'Spectral', serif; font-size: 1.5rem; color: var(--primary-night);
            margin-bottom: 0.5rem; text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }
        .donate-button {
            background: linear-gradient(to bottom right, #DAA520, #B8860B);
            color: #1a1a1a; padding: 0.8rem 2rem; border-radius: 0.5rem;
            font-weight: bold; font-size: 1.1rem; text-decoration: none;
            display: inline-block; transition: all 0.3s ease;
        }
        .donate-button:hover { transform: translateY(-2px); box-shadow: 5px 5px 15px rgba(255, 215, 0, 0.3); }
        @media (max-width: 768px) {
            .celestial-body { width: 60px; height: 60px; font-size: 0.9rem; }
        }
    </style>
</head>
<body data-theme="night">
    <div id="initialEntryOverlay" aria-label="Click to awaken the veil and start the experience.">
        <div style="display: flex; flex-direction: column; align-items: center;">
            <p class="entry-runic">ᛅᚾᛋᛁᛅᚾᛏ ᛂᚴᚬᛋ ᚬ᠀ ᚦᛅ ᛒᚬᛋᚾᛁᛅᚾ ᛬ ᛒᚢᚱᛅᛘᛁᛏᛋ</p>
            <h2 class="entry-title">Ancient Echoes of the Bosnian Pyramids</h2>
            <p class="entry-instruction">Click to Awaken the Veil</p>
        </div>
    </div>

    <div class="moon-orbit">
        <button class="celestial-body" id="menuButton" aria-label="Open portal navigation">
            <span class="celestial-body-rune">ᛗ</span>
            <span class="celestial-body-label">MENU</span>
        </button>
    </div>

    <div class="overlay-menu" id="overlayMenu">
        <button class="overlay-menu-close" id="closeMenuButton" aria-label="Close portal menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
        </button>
        <nav aria-label="Main navigation">
            <ul>
                <li><a href="#" data-page="home"><span class="runic-icon">ᚷ</span> Ancient Echoes</a></li>
                <li><a href="#" data-page="visoko"><span class="runic-icon">ᚱ</span> The Visoko Valley</a></li>
                <li><a href="#" data-page="meditation"><span class="runic-icon">ᛃ</span> The Inner Well</a></li>
                <li><a href="#" data-page="runeReading"><span class="runic-icon">ᛈ</span> The Seer's Whisper</a></li>
                <li><a href="#" data-page="storyteller"><span class="runic-icon">ᚹ</span> The Runic Chronicle</a></li>
                <li><a href="#" data-page="about"><span class="runic-icon">ᛇ</span> On the Veil</a></li>
                <li><a href="#" data-page="donate"><span class="runic-icon">ᚠ</span> Make an Offering</a></li>
                <li><a href="#" data-page="contact"><span class="runic-icon">ᚦ</span> Commune with a Keeper</a></li>
            </ul>
        </nav>
    </div>

    <div class="main-content-area" id="mainContentArea">
        <header class="app-header">
            <div class="title-container">
                <h1>ᛅᚾᛋᛁᛅᚾᛏ ᛂᚴᚬᛋ ᚬ᠀ ᚦᛅ ᛒᚬᛋᚾᛁᛅᚾ ᛬ ᛒᚢᚱᛅᛘᛁᛏᛋ</h1>
                <p class="runic-subtitle">Ancient Echoes of the Bosnian Pyramids</p>
            </div>
        </header>
        
        <section id="homePage" class="page active">
            <p class="text-gray-300 text-center mb-6 italic max-w-2xl">
                Welcome, seeker. Beneath the Bosnian soil, where myth and mountain meet, lie structures that pulse with forgotten energy. They call to those who remember a time before time.
            </p>

            <div class="w-full max-w-2xl bg-black/30 border border-yellow-400/20 rounded-lg p-4 mb-8 text-center">
                <h2 class="text-yellow-400 font-bold text-lg mb-2 font-spectral">An Interactive Journey</h2>
                <p class="text-gray-300 text-sm">
                    This portal is an <strong>interactive art project</strong> designed to evoke the mystery and wonder of ancient power. The wisdom, readings, and responses are generated for inspirational and entertainment purposes, encouraging a deeper connection to the enigmatic past.
                </p>
            </div>

            <div class="theme-switcher">
                <button class="theme-button active" data-theme-name="night" aria-label="Switch to night theme">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1.2em" height="1.2em"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69a.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-3.818 2.04-7.174 5.168-8.972a.75.75 0 01.818.162z" clip-rule="evenodd"></path></svg>
                    <span>Night</span>
                </button>
                <button class="theme-button" data-theme-name="day" aria-label="Switch to day theme">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="1.2em" height="1.2em"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.59a.75.75 0 11-1.06-1.06l1.59-1.591a.75.75 0 011.06 0zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.894 17.894a.75.75 0 011.06 0l1.591 1.591a.75.75 0 11-1.06 1.06l-1.591-1.59a.75.75 0 010-1.061zM12 18a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM5.106 17.894a.75.75 0 010-1.06l1.591-1.591a.75.75 0 111.06 1.06l-1.59 1.591a.75.75 0 01-1.06 0zM4.5 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H5.25a.75.75 0 01-.75-.75zM6.106 5.106a.75.75 0 011.06 0l1.591 1.591a.75.75 0 01-1.06 1.06L5.106 6.167a.75.75 0 010-1.06z"></path></svg>
                    <span>Day</span>
                </button>
            </div>
            
            <p class="text-yellow-400 mb-4 text-center">Touch a pyramid to listen to the ancient echoes.</p>

            <div class="pyramids-visual-group" id="pyramidGroup">
                <div class="pyramid-container">
                    <button class="pyramid side" data-pyramid="dragon" aria-label="Touch the Dragon Pyramid to receive a new whisper">
                        <div class="beam red"></div>
                        <div class="pyramid-shape"></div>
                        <h3 class="pyramid-name">Dragon</h3>
                    </button>
                    <button class="pyramid center" data-pyramid="sun" aria-label="Touch the Sun Pyramid to receive a new whisper">
                        <div class="beam green"></div>
                        <div class="pyramid-shape"></div>
                        <h3 class="pyramid-name">Sun</h3>
                    </button>
                    <button class="pyramid side" data-pyramid="moon" aria-label="Touch the Moon Pyramid to receive a new whisper">
                        <div class="beam gold"></div>
                        <div class="pyramid-shape"></div>
                        <h3 class="pyramid-name">Moon</h3>
                    </button>
                </div>
            </div>
            <div class="whisper-box" id="whisperBox">
                <div class="runic-text" id="runicOutput">Click a pyramid to begin...</div>
                <div class="english-translation" id="englishOutput"></div>
                <button class="runic-toggle" id="toggleTranslation">Show Translation</button>
            </div>
             <div class="echo-counter mt-8">
                <span class="echo-counter-label">Echoes Heard</span>
                <span class="echo-counter-value" id="visitCounter">...</span>
            </div>
        </section>

        <section id="visokoPage" class="page">
            <div class="page-content-container text-gray-300">
                <h2 class="text-3xl font-bold text-yellow-400 mb-6 text-center">The Visoko Valley</h2>
                <p class="text-lg italic mb-6 text-center">
                    In the heart of Bosnia lies the town of Visoko, a place where myth and mountain meet. Here, beneath the earth, are structures that pulse with a forgotten energy, calling to those who remember a time before time.
                </p>

                
                
                <p class="text-left mb-4 mt-8">
                    Long held by some to be the oldest and largest pyramids on Earth, the Bosnian Pyramids, particularly the Pyramid of the Sun, are a source of great debate and wonder. While mainstream science remains skeptical, research into the site suggests the presence of colossal man-made structures with a complex network of tunnels and chambers.
                </p>
                <p class="text-left">
                    This land is believed to be a point of immense spiritual power, an energy vortex where the veil between worlds is thin. Our portal serves as a digital echo of this place, inviting you to explore the mysteries that still lie beneath the surface.
                </p>
            </div>
        </section>

        <section id="meditationPage" class="page">
            <div class="page-content-container">
                <h2 class="text-3xl font-bold text-yellow-400 mb-6 text-center">Guided Meditation</h2>
                <p class="text-gray-300 text-center mb-4">Connect with the ancient energies through focused intention.</p>
                <div class="meditation-circle" id="meditationCircle">
                    <div class="rune-symbol" id="meditationRune">ᛗ</div>
                </div>
                <p id="meditationStatus" class="text-gray-400 mt-4 text-center">Ready to begin your inner journey.</p>
                <button class="meditation-button mt-4" id="toggleMeditationVoiceButton" aria-label="Toggle meditation voice">Enable Meditation Voice</button>

                <div class="meditation-call-to-action">
                    <p class="mt-8">
                        The journey to the self is a sacred path. Your support helps us keep this space of inner peace and reflection open to all.
                    </p>
                    <a href="#donatePage" class="donate-button-small mt-4">Make an Offering</a>
                </div>
            </div>
        </section>

        <section id="runeReadingPage" class="page">
            <div class="page-content-container">
                <h2 class="text-3xl font-bold text-yellow-400 mb-6 text-center">Rune Reading</h2>
                <div class="user-input-section">
                    <input type="text" id="runeQuestionInput" class="w-full p-2 rounded bg-gray-800 text-white text-center" placeholder="Ask the runes a question..." aria-label="Rune question input">
                    <button class="whisper-button" id="drawRunesButton">Draw Runes</button>
                </div>
                <div class="text-center">
                    <div id="runeDisplay"></div>
                    <div id="runeInterpretation"></div>
                    <button class="meditation-button mt-4 hidden" id="toggleRuneVoiceButton" aria-label="Toggle reading voice">Enable Reading Voice</button>
                </div>
                
                <div id="postReadingMessage" class="post-reading-message">
                    <p>The oracle's whisper requires great energy to sustain. Consider supporting the keepers of the runes.</p>
                    <a href="#donatePage" class="donate-button-small">Make an Offering</a>
                </div>

                <div class="rune-alphabet-grid">
                </div>

                <div class="rune-image-gallery">
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </div>

                <div class="rune-history">
                    <h3>Dr. Semir Osmanagić and the Scientific Approach</h3>
                    <p>
                        The investigation into the Bosnian Valley of the Pyramids is spearheaded by Dr. Semir Osmanagić, a Bosnian-American author and researcher. Through years of dedicated and often self-funded hard work, he has championed the project, bringing a multidisciplinary scientific approach to the excavations. Holding a Ph.D. in the Sociology of History with a focus on the Mayan civilization, Dr. Semir Osmanagić has invited numerous experts from various fields—including geology, physics, and archaeology—to analyze the site.
                    </p>
                    <p class="mt-4">
                        A key aspect of his approach involves avoiding purely speculative theories in favor of measurable data. This includes material analysis, georadar scanning, and radiocarbon dating. One of the most significant findings came from this methodology. A fossilized leaf found on a conglomerate block within the excavations was sent for analysis. A laboratory in Kiel, Germany, conducted radiocarbon dating on the sample, successfully proving the artifact to be approximately 34,000 years old. This suggests that the construction, and the civilization responsible, could be far older than any currently recognized advanced ancient culture.
                    </p>
                </div>
            </div>
        </section>
        
        <section id="storytellerPage" class="page">
            <div class="page-content-container">
                <h2 class="text-3xl font-bold text-yellow-400 mb-6 text-center">The Runic Chronicle</h2>
                <p class="text-gray-300 text-center mb-4">
                    The runes whisper a new theme each time the moon passes the sun. Listen to the rune below and share a story from your world.
                </p>
                <div class="whisper-box" id="storytellerRuneBox">
                    <div class="storyteller-runes" id="storytellerRune">ᛞ</div>
                    <div class="storyteller-meaning" id="storytellerMeaning">Dagaz: Dawn, breakthrough, a new day.</div>
                </div>

                <div class="mt-8 flex flex-col items-center">
                    <p class="text-gray-300 text-center mb-2" id="storytellerStatusMessage">Tell your tale, keeper.</p>
                    <textarea id="storytellerInput" class="w-full p-4 rounded bg-gray-800 text-white h-40" placeholder="Write your story here..."></textarea>
                    <button class="whisper-button mt-4" id="submitStoryButton" disabled>Submit Your Story</button>
                    <p class="text-red-400 mt-2 hidden" id="storytellerErrorMessage">Please sign in to submit a story.</p>
                    <p class="text-yellow-400 text-center font-spectral italic mt-4 hidden" id="storytellerSuccessMessage"></p>
                </div>
                
                <div class="storyteller-stories">
                    <h3 class="text-yellow-400">Echoes from the Community</h3>
                    <div id="storiesContainer">
                        <p class="text-gray-500 text-center italic">Loading stories from the depths of time...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="aboutPage" class="page">
            <div class="page-content-container text-gray-300 text-center">
                <h2 class="text-3xl font-bold text-yellow-400 mb-6 text-center">On the Veil</h2>
                <p class="mb-4">
                    This portal is an interactive art project designed to evoke the mystery and wonder surrounding sites of ancient power, like the Bosnian Pyramids. It is an exploration of myth, energy, and the whispers of history. We are dedicated to providing a space for contemplation and imagination, allowing visitors to connect with the enigmatic past on a personal level.
                </p>
                <p>
                    Using simulated interactions and browser-based technologies, we aim to create a space for contemplation and imagination. The wisdom, readings, and responses are generated for inspirational and entertainment purposes, encouraging a deeper connection to the enigmatic past.
                </p>

                <div class="about-call-to-action">
                    <h3 class="text-center">Join the Keepers of the Echoes</h3>
                    <p class="mt-4">
                        This portal, a bridge between worlds, is maintained by a small group of devoted keepers. Their work ensures the whispers of the past continue to guide our present. Join us in this sacred duty.
                    </p>
                    <a href="https://bosnianpyramids.netlify.app/#donatePage" class="donate-button mt-4">Become a Keeper</a>
                </div>
            </div>
        </section>

        <section id="donatePage" class="page">
            <div class="page-content-container text-gray-300 text-center">
                <h2 class="text-3xl font-bold text-yellow-400 mb-6 text-center">Support the Veil of Amenti</h2>
                <p class="mb-6">
                    The echoes of the Bosnian Pyramids fade without an audience. Your contribution is more than a donation—it is an offering to the ancient spirits that keep this portal open. It ensures the veil remains thin, so that we may continue to receive their whispers and share their wisdom.
                </p>
                
                <div class="w-full max-w-sm mx-auto my-6">
                    <div class="text-gray-400 text-sm mb-1 text-center">
                        Goal: $1,200 for Annual Maintenance
                    </div>
                    <div class="relative pt-1">
                        <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-600">
                            <div id="donation-progress" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-yellow-400 transition-all duration-1000 ease-in-out"></div>
                        </div>
                    </div>
                    <div class="text-yellow-400 text-lg font-bold text-center">
                        <span>$</span><span id="current-donations">...</span><span> / $1200</span>
                    </div>
                </div>

                <p class="mb-4">
                    <span class="text-yellow-400 font-bold">Choose your offering</span> and join the eternal echo.
                </p>
                
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8">
                    <a href="https://buy.stripe.com/28E6oH6t188VfGf8LN1gs00" class="whisper-button w-full md:w-auto">
                        <span class="block font-bold text-xl">$5</span>
                        <span class="block text-sm">One-Time Offering</span>
                    </a>
                    <a href="https://buy.stripe.com/8x24gz4kT74R51B9PR1gs01" class="whisper-button w-full md:w-auto">
                        <span class="block font-bold text-xl">$15</span>
                        <span class="block text-sm">Monthly Keeper</span>
                    </a>
                    <a href="https://buy.stripe.com/bJefZhbNlgFr0Ll3rt1gs02" class="whisper-button w-full md:w-auto">
                        <span class="block font-bold text-xl">$50</span>
                        <span class="block text-sm">Yearly Guardian</span>
                    </a>
                </div>
                
                <a href="https://buy.stripe.com/6oU5kC1LraJKan8f1UeEo09" target="_blank" rel="noopener noreferrer" class="donate-button mt-4">
                    Make a Custom Offering
                </a>
            </div>
        </section>

        <section id="contactPage" class="page">
            <div class="page-content-container">
                <h2 class="text-3xl font-bold text-yellow-400 mb-6 text-center">Commune with a Keeper</h2>
                <form id="contactForm" class="flex flex-col items-center gap-4 w-full max-w-md mx-auto">
                    <textarea id="keeperMessage" class="w-full p-2 rounded bg-gray-800 text-white" rows="4" placeholder="Your message..." aria-label="Your message to the keepers"></textarea>
                    <button type="submit" class="whisper-button">Send Message</button>
                    <p id="messageFeedback"></p>
                </form>
            </div>
        </section>
    </div>

    <div class="audio-controls">
        <div class="volume-container">
            <span>🔊</span>
            <input type="range" id="masterVolumeSlider" min="-60" max="0" value="-10" step="1" aria-label="Master volume control">
        </div>
        <button class="audio-toggle-button" id="audioToggleButton" aria-label="Toggle ambient audio">Play Ambient Melodies</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', async () => {
        // --- Element References ---
        const allPages = document.querySelectorAll('.page');
        const whisperBox = document.getElementById('whisperBox');
        const runicOutput = document.getElementById('runicOutput');
        const englishOutput = document.getElementById('englishOutput');
        const toggleTranslationButton = document.getElementById('toggleTranslation');
        const menuButton = document.getElementById('menuButton');
        const overlayMenu = document.getElementById('overlayMenu');
        const closeMenuButton = document.getElementById('closeMenuButton');
        const navLinks = document.querySelectorAll('.overlay-menu nav ul li a');
        const themeButtons = document.querySelectorAll('.theme-button');
        const initialEntryOverlay = document.getElementById('initialEntryOverlay');
        const mainContentArea = document.getElementById('mainContentArea');
        const audioToggleButton = document.getElementById('audioToggleButton');
        const meditationCircle = document.getElementById('meditationCircle');
        const meditationRune = document.getElementById('meditationRune');
        const meditationStatus = document.getElementById('meditationStatus');
        const toggleMeditationVoiceButton = document.getElementById('toggleMeditationVoiceButton');
        const contactForm = document.getElementById('contactForm');
        const keeperMessage = document.getElementById('keeperMessage');
        const messageFeedback = document.getElementById('messageFeedback');
        const drawRunesButton = document.getElementById('drawRunesButton');
        const runeQuestionInput = document.getElementById('runeQuestionInput');
        const runeDisplay = document.getElementById('runeDisplay');
        const runeInterpretation = document.getElementById('runeInterpretation');
        const toggleRuneVoiceButton = document.getElementById('toggleRuneVoiceButton');
        const runeAlphabetGrid = document.querySelector('.rune-alphabet-grid');
        const visitCounterElement = document.getElementById('visitCounter');
        const postReadingMessage = document.getElementById('postReadingMessage');
        const masterVolumeSlider = document.getElementById('masterVolumeSlider');
        const storytellerRune = document.getElementById('storytellerRune');
        const storytellerMeaning = document.getElementById('storytellerMeaning');
        const storytellerInput = document.getElementById('storytellerInput');
        const submitStoryButton = document.getElementById('submitStoryButton');
        const storiesContainer = document.getElementById('storiesContainer');
        const storytellerStatusMessage = document.getElementById('storytellerStatusMessage');
        const storytellerErrorMessage = document.getElementById('storytellerErrorMessage');
        const storytellerSuccessMessage = document.getElementById('storytellerSuccessMessage');
        const donationProgress = document.getElementById('donation-progress');
        const currentDonations = document.getElementById('current-donations');

        let isGenerating = false;
        let isAmbientPlaying = false;
        let isMeditationTTSActive = false;
        let isRuneTTSActive = false;
        let currentStorytellerRune = null;

        // --- Firebase Initialization and Auth ---
        let app, auth, db;
        let userId = null;

        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. The app will not be able to save stories.");
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase authenticated. User ID:", userId);
                        submitStoryButton.disabled = false;
                        storytellerErrorMessage.classList.add('hidden');
                    } else {
                        userId = null;
                        console.error("Firebase authentication failed. App cannot save stories.");
                        submitStoryButton.disabled = true;
                        storytellerErrorMessage.textContent = "Please sign in to submit a story.";
                        storytellerErrorMessage.classList.remove('hidden');
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            }
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }

        const ancientWisdoms = [
            { runic: "ᛞᚱᛁᛗ ᛞᛖᛈᛖᚱ", english: "Dream deeper." }, { runic: "ᛋᛏᚨᚱᛋ ᚹᚨᛏᚲᚺ", english: "The stars watch." }, { runic: "ᛖᚲᚺᛟ ᛟᚠ ᛏᛁᛗᛖ", english: "Listen to time's echo." }, { runic: "ᚦᛅ ᛋᛏᛟᚾᛋ ᛋᛒᛂᛅᚴ", english: "The stones speak to those who listen." }, { runic: "ᚢᛅᛁᛚ ᛁᛋ ᚦᛁᚾ", english: "Where the worlds touch, the veil is thin." }, { runic: "ᛋᛂᛅᚴ ᚦᛅ ᛏᚱᚢᚦ", english: "Seek the truth, not the comfort of answers." }, { runic: "ᛒᛅᛚᛅᚾᛋ ᛁᛋ ᚴᛅᛁ", english: "Balance is the key to unlocking potential." }, { runic: "ᛂᚾᛅᚱᚵᛁ ᚠᛚᚬᚢᛋ", english: "Energy flows where intention goes." }, { runic: "ᚦᛅ ᛒᛅᚦ ᛁᛋ ᚢᛁᚦᛁᚾ", english: "The path you seek is found within." }, { runic: "ᚦᛅ ᛘᚬᚢᚾᛏᛅᛁᚾ ᛒᚱᛂᛅᚦᛋ", english: "The mountain breathes with the ages." }, { runic: "ᚢᚱ ᚬᚠᚠᛂᚱᛁᚾᚵ ᛋᚢᛋᛏᛅᛁᚾᛋ ᚦᛁᛋ ᚢᛅᛁᛚ", english: "Your offering sustains this veil." }, { runic: "ᛅ ᛚᛁᚵᚦ ᚬᚠ ᛘᛅᚾᛃ ᛋᛏᚱᛅᛁᚵᚦᛋ ᚦᛁᛋ ᛒᚬᛏᛅᛚ", english: "A light from many strengthens this portal." }
        ];
        
        const keeperAnswers = [
            "The answer lies not in the stars, but in the silence between your thoughts. Listen to it.", "A river cannot be pushed. Your path will reveal itself when the time is right, not a moment sooner.", "The shadow you cast is proof of the light within you. Do not fear the darkness you create.", "To find what you seek, you must first lose your way. The destination is not a place, but a new perspective.", "The heaviest stone is the one you refuse to put down. What burden do you carry that is not yours?", "Look for the echo. The first sound is the question, but the truth is in how it returns to you.", "A seed does not know it is a tree until it breaks through the earth. Your potential is buried; have the courage to grow.", "The veil is thinnest where you least expect it. Pay attention to the whispers in the mundane.", "You ask for a map, but the journey changes the land itself. Walk with faith, not with sight."
        ];

        const runeReadings = [
            { runes: "ᚠᛉᛟ", interpretation: "Protected wealth and inheritance. Your foundations are strong. Do not fear loss, for your prosperity is watched over by ancestral spirits." }, { runes: "ᚢᚱᚨ", interpretation: "A journey of strength and wisdom is ahead. Primal power fuels your movement, and divine messages will guide your way." }, { runes: "ᚦᛖᛚ", interpretation: "A gateway of change lies before you. Do not force the path; let the flow guide you through the thorns to the other side." }, { runes: "ᚹᛗᛒ", interpretation: "Joy in community and new beginnings. This is a time for connection, celebrating the self, and nurturing growth." }
        ];
        
        const elderFuthark = [
            { char: 'ᚠ', name: 'Fehu', meaning: 'Wealth, cattle, new beginnings.' }, { char: 'ᚢ', name: 'Uruz', meaning: 'Strength, primal force, courage.' }, { char: 'ᚦ', name: 'Thurisaz', meaning: 'Thorn, change, directed force.' }, { char: 'ᚨ', name: 'Ansuz', meaning: 'Communication, wisdom, insight.' }, { char: 'ᚱ', name: 'Raido', meaning: 'Journey, movement, life path.' }, { char: 'ᚲ', name: 'Kenaz', meaning: 'Torch, illumination, creativity.' }, { char: 'ᚷ', name: 'Gebo', meaning: 'Gift, partnership, generosity.' }, { char: 'ᚹ', name: 'Wunjo', meaning: 'Joy, harmony, fellowship.' }, { char: 'ᚺ', name: 'Hagalaz', meaning: 'Hail, disruption, uncontrollable forces.' }, { char: 'ᚾ', name: 'Nauthiz', meaning: 'Need, delay, resistance.' }, { char: 'ᛁ', name: 'Isa', meaning: 'Ice, stillness, psychological block.' }, { char: 'ᛃ', name: 'Jera', meaning: 'Harvest, cycles, success from effort.' }, { char: 'ᛇ', name: 'Eihwaz', meaning: 'Yew, endurance, a bridge between worlds.' }, { char: 'ᛈ', name: 'Perthro', meaning: 'Lot-cup, mystery, fate, hidden knowledge.' }, { char: 'ᛉ', name: 'Algiz', meaning: 'Protection, defense, connection with the divine.' }, { char: 'ᛋ', name: 'Sowilo', meaning: 'Sun, wholeness, power, success.' }, { char: 'ᛏ', name: 'Tiwaz', meaning: 'Tyr, justice, sacrifice, leadership.' }, { char: 'ᛒ', name: 'Berkano', meaning: 'Birch, fertility, new growth, nurture.' }, { char: 'ᛖ', name: 'Ehwaz', meaning: 'Horse, teamwork, trust, movement.' }, { char: 'ᛗ', name: 'Mannaz', meaning: 'Man, humanity, the self.' }, { char: 'ᛚ', name: 'Laguz', meaning: 'Water, intuition, emotion, flow.' }, { char: 'ᛜ', name: 'Ingwaz', meaning: 'Ing, potential, home, retreat.' }, { char: 'ᛟ', name: 'Othala', meaning: 'Inheritance, home, ancestry.' }, { char: 'ᛞ', name: 'Dagaz', meaning: 'Dawn, breakthrough, a new day.' }
        ];

        const runeReflections = {
            'ᚠ': ["You have shared a story of abundance. The veil recognizes this gift and echoes its prosperity back to you.", "Your tale of beginnings plants a seed in the timeless soil. May it grow into a mighty tree."],
            'ᚢ': ["The strength in your story fortifies the veil itself. The echoes of your power will resonate for ages.", "You speak of primal force, and the ancient stones listen, recognizing a power as old as their own."],
            'ᚦ': ["Your story of change is a gateway. In telling it, you have passed through, leaving the path clearer for others.", "The thorn you described has been offered to the veil. Its sharpness is now a tool of protection for this sacred space."],
            'ᚨ': ["A story of wisdom is a drink from the deepest well. Thank you for sharing this sacred knowledge.", "Your words carry the breath of the ancients. The message has been heard and understood."],
            'ᚱ': ["The veil has received your echo. By sharing your journey, you have charted a path for others to follow.", "Every journey is a circle. Your story has returned to its source, richer for the telling."],
            'ᚲ': ["Your tale of illumination is a torch in the darkness. It will light the way for those who are lost.", "Creativity is the language of the cosmos. Your story is a verse in its endless song."],
            'ᚷ': ["To give a story is the greatest gift. It has been received with gratitude.", "You speak of partnership, and in doing so, have strengthened the bond between this world and the veil."],
            'ᚹ': ["Your joy has been woven into the fabric of this place. It is a light that will warm other seekers who pass this way.", "Harmony shared is harmony multiplied. Your story brings balance to the echoes."],
            'ᚺ': ["You have given form to chaos, and in doing so, have shown its purpose. The storm you described now nourishes the ground for new growth.", "Disruption is the mother of change. Your story is a testament to the strength found in breaking."],
            'ᚾ': ["By giving voice to your need, you have begun the process of fulfillment. The veil acknowledges your patience.", "Your story of resistance is a shield. It will lend strength to others in their own trials."],
            'ᛁ': ["In describing stillness, you have revealed the universe of motion it contains. A profound and subtle truth.", "Your tale of ice is a mirror. It reflects a hidden truth, now clear for all to see."],
            'ᛃ': ["You have shared a tale of the harvest. The seeds of your experience will feed the wisdom of the community.", "The cycle turns, and your story marks its passage. What was sown has been reaped and understood."],
            'ᛇ': ["Your story bridges worlds, connecting the above and the below. It is a powerful work of magic.", "Endurance is the theme of your tale, and it has been etched into the memory of this place forever."],
            'ᛈ': ["You have shared a mystery, adding to the great enigma. The veil does not offer an answer, but a deeper question.", "Fate is a thread, and your story has shown its pattern. Others will see their own threads reflected in yours."],
            'ᛉ': ["A story of protection is a ward against darkness. Thank you for strengthening the defenses of this sacred space.", "Your words are a shield. The divine connection you described has been felt and amplified."],
            'ᛋ': ["Your tale of triumph radiates like the sun. It has become a beacon within the veil, a testament to the power of a focused will.", "Wholeness is the goal, and your story is a step upon that path. It shines brightly."],
            'ᛏ': ["You speak of justice and sacrifice, the cornerstones of cosmic law. Your story honors this ancient balance.", "The leadership shown in your tale inspires the echoes of heroes past. It is a worthy chronicle."],
            'ᛒ': ["A story of new growth is a promise of the future. The veil nurtures this promise and will help it bloom.", "You have shared a tale of nurturing, and in doing so, have tended to the roots of the world tree."],
            'ᛖ': ["Your story of teamwork shows the power of the herd. It is a reminder that no soul journeys alone.", "Trust is the bond that holds the worlds together. Your tale strengthens that bond."],
            'ᛗ': ["In sharing a story of the self, you have shared a story of all humanity. It is a profound reflection.", "Your tale is a mirror in which others will see themselves. This is the great power of the chronicle."],
            'ᛚ': ["Your story flows like water, finding its own path to the great sea of shared consciousness.", "Intuition is the whisper of the veil. Thank you for amplifying its voice with your tale."],
            'ᛜ': ["A story of inner work and potential is a sacred thing. The seed you have described will be protected here.", "You have shared a tale of home, and in doing so, have made this place more of a home for all."],
            'ᛟ': ["Your tale of inheritance honors all who came before. The ancestors listen and are pleased.", "By sharing a piece of your ancestry, you have enriched the lineage of all who seek wisdom here."],
            'ᛞ': ["You have chronicled your night, and in doing so, have helped manifest the dawn. The veil recognizes your breakthrough.", "A new day is not given, but made. Your story is an act of creation, and it is beautiful."]
        };


        function buildRuneAlphabet() {
            if (!runeAlphabetGrid) return;
            runeAlphabetGrid.innerHTML = '';
            elderFuthark.forEach(rune => {
                const item = document.createElement('div');
                item.className = 'rune-alphabet-item';
                item.innerHTML = `<div class="rune-alphabet-char">${rune.char}</div><div class="rune-alphabet-name">${rune.name}</div>`;
                runeAlphabetGrid.appendChild(item);
            });
        }
        buildRuneAlphabet();

        function speak(text) {
            if (!('speechSynthesis' in window)) return;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.8;
            utterance.pitch = 0.9;
            speechSynthesis.speak(utterance);
        }

        toggleMeditationVoiceButton.addEventListener('click', () => {
            isMeditationTTSActive = !isMeditationTTSActive;
            toggleMeditationVoiceButton.textContent = isMeditationTTSActive ? "Disable Meditation Voice" : "Enable Meditation Voice";
            toggleMeditationVoiceButton.classList.toggle('active', isMeditationTTSActive);
            if (isMeditationTTSActive) speak(meditationStatus.textContent);
            else speechSynthesis.cancel();
        });

        toggleRuneVoiceButton.addEventListener('click', () => {
            isRuneTTSActive = !isRuneTTSActive;
            toggleRuneVoiceButton.textContent = isRuneTTSActive ? "Disable Reading Voice" : "Enable Reading Voice";
            toggleRuneVoiceButton.classList.toggle('active', isRuneTTSActive);
            if (isRuneTTSActive && runeInterpretation.textContent) speak(runeInterpretation.textContent);
            else speechSynthesis.cancel();
        });

        function getAncientCounsel() {
            if (isGenerating) return;
            isGenerating = true;
            runicOutput.textContent = '';
            englishOutput.textContent = '';
            englishOutput.classList.remove('visible');
            toggleTranslationButton.style.display = 'none';
            whisperBox.classList.add('loading');
            playCounselWhisper();
            setTimeout(() => {
                const wisdom = ancientWisdoms[Math.floor(Math.random() * ancientWisdoms.length)];
                runicOutput.textContent = wisdom.runic;
                englishOutput.textContent = wisdom.english;
                whisperBox.classList.remove('loading');
                toggleTranslationButton.style.display = 'inline-block';
                isGenerating = false;
            }, 1500);
        }

        function getRuneReading() {
            const question = runeQuestionInput.value.trim();
            if (!question) {
                runeInterpretation.textContent = "You must ask a question to receive a reading.";
                return;
            }
            if (isGenerating) return;
            isGenerating = true;
            runeDisplay.textContent = '';
            runeInterpretation.textContent = 'The runes are being cast...';
            toggleRuneVoiceButton.classList.add('hidden');
            postReadingMessage.style.display = 'none';
            playCounselWhisper();
            setTimeout(() => {
                const reading = runeReadings[Math.floor(Math.random() * runeReadings.length)];
                runeDisplay.textContent = reading.runes;
                runeInterpretation.textContent = reading.interpretation;
                toggleRuneVoiceButton.classList.remove('hidden');
                postReadingMessage.style.display = 'block';
                if (isRuneTTSActive) speak(reading.interpretation);
                isGenerating = false;
            }, 2500);
        }

        function initializeStoryteller() {
            const randomRune = elderFuthark[Math.floor(Math.random() * elderFuthark.length)];
            storytellerRune.textContent = randomRune.char;
            storytellerMeaning.textContent = `${randomRune.name}: ${randomRune.meaning}`;
            currentStorytellerRune = randomRune;

            if (db) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const storiesCollectionRef = collection(db, `artifacts/${appId}/public/data/runic_stories`);
                
                onSnapshot(query(storiesCollectionRef, orderBy('timestamp', 'desc'), limit(20)), (querySnapshot) => {
                    const stories = [];
                    querySnapshot.forEach((doc) => stories.push({ id: doc.id, ...doc.data() }));
                    displayStories(stories);
                }, (error) => {
                    console.error("Error listening to stories:", error);
                    storiesContainer.innerHTML = `<p class="text-red-400 text-center">Error loading stories.</p>`;
                });
            } else {
                storiesContainer.innerHTML = `<p class="text-red-400 text-center">Cannot connect to the chronicle.</p>`;
            }
        }

        async function submitStory() {
            if (!db || !userId) {
                storytellerErrorMessage.textContent = "You must be signed in to submit a story.";
                storytellerErrorMessage.classList.remove('hidden');
                setTimeout(() => storytellerErrorMessage.classList.add('hidden'), 5000);
                return;
            }

            const storyText = storytellerInput.value.trim();
            if (storyText.length < 10) {
                storytellerStatusMessage.textContent = "Your story is too brief. A keeper's tale must be told with more detail.";
                setTimeout(() => storytellerStatusMessage.textContent = "Tell your tale, keeper.", 5000);
                return;
            }

            submitStoryButton.disabled = true;
            storytellerStatusMessage.textContent = "Submitting your echo to the veil...";

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const storiesCollectionRef = collection(db, `artifacts/${appId}/public/data/runic_stories`);
                await addDoc(storiesCollectionRef, {
                    rune: currentStorytellerRune.char,
                    story: storyText,
                    userId: userId,
                    timestamp: serverTimestamp(),
                });
                
                storytellerInput.classList.add('hidden');
                storytellerStatusMessage.textContent = ''; 

                const reflections = runeReflections[currentStorytellerRune.char] || ["Your story has been received and woven into the great tapestry."];
                const reflection = reflections[Math.floor(Math.random() * reflections.length)];

                storytellerSuccessMessage.textContent = reflection;
                storytellerSuccessMessage.classList.remove('hidden');

                setTimeout(() => {
                    storytellerSuccessMessage.classList.add('hidden');
                    storytellerInput.value = ''; 
                    storytellerInput.classList.remove('hidden'); 
                    storytellerStatusMessage.textContent = "Tell your tale, keeper.";
                    submitStoryButton.disabled = false;
                }, 10000);

            } catch (e) {
                console.error("Error adding document: ", e);
                storytellerErrorMessage.textContent = "Failed to submit story. Please try again.";
                storytellerErrorMessage.classList.remove('hidden');
                setTimeout(() => storytellerErrorMessage.classList.add('hidden'), 5000);
                submitStoryButton.disabled = false;
            }
        }

        function displayStories(stories) {
            storiesContainer.innerHTML = '';
            if (stories.length === 0) {
                storiesContainer.innerHTML = `<p class="text-gray-500 text-center italic">No stories have been written yet. Be the first!</p>`;
                return;
            }
            stories.forEach(story => {
                const storyCard = document.createElement('div');
                storyCard.className = 'story-card';
                const timestamp = story.timestamp ? story.timestamp.toDate().toLocaleString() : 'Just now...';
                storyCard.innerHTML = `
                    <div class="story-rune">${story.rune}</div>
                    <p class="story-text">${story.story}</p>
                    <div class="story-meta">
                        <span class="story-user-id" title="${story.userId}">By: ${story.userId.substring(0, 8)}...</span>
                        <span class="story-timestamp">${timestamp}</span>
                    </div>`;
                storiesContainer.appendChild(storyCard);
            });
        }
        
        const panner = new Tone.Panner().toDestination();
        const reverb = new Tone.Reverb({ decay: 10, preDelay: 0.1, wet: 0.3 }).toDestination();
        const piano = new Tone.FMSynth({ oscillator: { type: "sine" }, envelope: { attack: 2, decay: 0.5, sustain: 0.8, release: 4 }, modulation: { type: "square" }, modulationIndex: 10 }).connect(reverb).connect(panner);
        piano.volume.value = -12;
        const violin = new Tone.Synth({ oscillator: { type: "sawtooth" }, envelope: { attack: 2, decay: 1, sustain: 1, release: 3 }, filter: { Q: 2, frequency: 1500 }, filterEnvelope: { attack: 2, decay: 1, sustain: 0.5, release: 2, baseFrequency: 500 } }).connect(reverb).connect(panner);
        violin.volume.value = -14;
        
        let ambientMelody = null;
        function playAmbientMelody() {
            if (!ambientMelody) {
                ambientMelody = new Tone.Sequence((time, note) => {
                    piano.triggerAttackRelease(note.piano, "4n", time);
                    violin.triggerAttackRelease(note.violin, "2n", time);
                    panner.pan.value = (Math.random() - 0.5) * 0.5;
                }, [ { piano: ["C3"], violin: ["G4"] }, { piano: ["E3"], violin: ["A4"] }, { piano: ["G3"], violin: ["B4"] }, { piano: ["F3"], violin: ["A4"] }, null, { piano: ["C3"], violin: ["G4"] }, { piano: ["E3"], violin: ["F4"] }, null, { piano: ["D3"], violin: ["E4"] } ], "2n").start(0);
                ambientMelody.loop = true;
                ambientMelody.loopEnd = "8m";
            }
            Tone.Transport.start();
        }
        
        function stopAmbientMelody() { if (ambientMelody) Tone.Transport.stop(); }

        const counselWhisperSynth = new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.1, decay: 1.0, release: 1.5 } }).toDestination();
        const menuToggleSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sine" }, envelope: { attack: 1, decay: 0.1, sustain: 0.5, release: 2 } }).toDestination().connect(new Tone.Reverb(3.5).toDestination());
        function playCounselWhisper() { try { counselWhisperSynth.triggerAttackRelease("1.5s"); } catch(e){} }
        function playMenuSound() { try { menuToggleSynth.triggerAttackRelease(["C4", "E4", "G4"], "4n", Tone.now()); } catch(e) {} }

        masterVolumeSlider.addEventListener('input', (e) => Tone.Destination.volume.value = parseFloat(e.target.value));
        Tone.Destination.volume.value = parseFloat(masterVolumeSlider.value);

        initialEntryOverlay.addEventListener('click', () => {
            initialEntryOverlay.classList.add('hidden');
            mainContentArea.classList.add('active');
            updateCounter();
        }, { once: true });

        audioToggleButton.addEventListener('click', () => {
            isAmbientPlaying = !isAmbientPlaying;
            audioToggleButton.textContent = isAmbientPlaying ? "Stop Ambient Melodies" : "Play Ambient Melodies";
            audioToggleButton.classList.toggle('active', isAmbientPlaying);
            if (isAmbientPlaying) Tone.start().then(playAmbientMelody);
            else stopAmbientMelody();
        });

        document.getElementById('pyramidGroup').addEventListener('click', (e) => {
            const pyramidButton = e.target.closest('.pyramid');
            if (pyramidButton) {
                const beam = pyramidButton.querySelector('.beam');
                if (beam) {
                    beam.style.opacity = '1';
                    setTimeout(() => beam.style.opacity = '0', 2000);
                }
                getAncientCounsel();
            }
        });

        toggleTranslationButton.addEventListener('click', () => englishOutput.classList.toggle('visible'));
        drawRunesButton.addEventListener('click', getRuneReading);
        submitStoryButton.addEventListener('click', submitStory);
        menuButton.addEventListener('click', () => { playMenuSound(); overlayMenu.classList.add('active'); });
        closeMenuButton.addEventListener('click', () => { playMenuSound(); overlayMenu.classList.remove('active'); });

        function showPage(pageId) {
            window.scrollTo(0, 0);
            speechSynthesis.cancel();
            allPages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                if (pageId === 'storytellerPage' && db) initializeStoryteller();
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                playMenuSound();
                const pageId = e.currentTarget.dataset.page + 'Page';
                showPage(pageId);
                overlayMenu.classList.remove('active');
            });
        });

        themeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const themeName = button.dataset.themeName;
                document.body.dataset.theme = themeName;
                themeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                localStorage.setItem('theme', themeName);
            });
        });

        const savedTheme = localStorage.getItem('theme') || 'night';
        document.body.dataset.theme = savedTheme;
        themeButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.themeName === savedTheme);
        });

        contactForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = keeperMessage.value.trim();
            if (!message) {
                messageFeedback.textContent = 'You must scribe a question for the keeper to answer.';
                setTimeout(() => { messageFeedback.textContent = ''; }, 4000);
                return;
            }
            const answer = keeperAnswers[Math.floor(Math.random() * keeperAnswers.length)];
            messageFeedback.textContent = answer;
            playCounselWhisper();
            setTimeout(() => {
                contactForm.reset();
                messageFeedback.textContent = '';
            }, 8000); 
        });

        const meditationScripts = {
            'ᛗ': "Focus on the self. Feel the connection to all of humanity.", 'ᛟ': "Think of your heritage, your ancestors. Feel their strength.", 'ᛞ': "Embrace the dawn of a new understanding. A breakthrough is near.", 'ᚲ': "Open yourself to illumination and creativity. Knowledge flows to you.", 'ᛋ': "Feel wholeness and success. The sun's energy empowers you.", 'ᛁ': "Find stillness within. Be calm and centered, like ice.", 'ᚹ': "Allow joy and harmony to fill your spirit.", 'ᛚ': "Go with the flow. Trust your intuition, like water."
        };
        const meditationRunes = Object.keys(meditationScripts);
        let runeIndex = 0;

        setInterval(() => {
            meditationCircle.classList.toggle('pulsing');
            runeIndex = (runeIndex + 1) % meditationRunes.length;
            const currentRune = meditationRunes[runeIndex];
            meditationRune.textContent = currentRune;
            const script = meditationScripts[currentRune];
            meditationStatus.textContent = script;
            if (isMeditationTTSActive) speak(script);
        }, 8000);

        function updateCounter() {
            let count = parseInt(localStorage.getItem('visitCount') || '0') + 1;
            localStorage.setItem('visitCount', count);
            visitCounterElement.textContent = count;
        }
        
        let initialCount = localStorage.getItem('visitCount') || '0';
        visitCounterElement.textContent = initialCount;

        function updateDonationProgress() {
            const goal = 1200;
            const currentAmount = parseInt(localStorage.getItem('donationAmount')) || 450;
            const percentage = Math.min((currentAmount / goal) * 100, 100);
            donationProgress.style.width = `${percentage}%`;
            currentDonations.textContent = currentAmount;
        }

        updateDonationProgress();
        
        if (typeof window.firebaseInit === 'function') {
            window.firebaseInit();
        }
    });
</script>
</body>
</html>
